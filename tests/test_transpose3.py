import time
import unittest


# import app.dma as dma


# import app.memory_utils as mu


def build_mock_rgb_data(lights_per_strip: int, num_strips: int):
    component = int(0b01000000)
    rgb = [0] * 3
    rgb[0] = component
    rgb[1] = component
    rgb[2] = component
    rgb_bytes = bytes(rgb)
    rgb_data_for_one_strip = [rgb_bytes] * 2
    return [rgb_data_for_one_strip] * 32


def transform_rgb_data_to_words_array(rgb_data):
    return 0


def swap(a0, a1, j, m):
    t = (a0 ^ (a1 >> j)) & m
    return a0 ^ t, a1 ^ (t << j)


def transpose32(gpio_data):
    a0 = gpio_data[0]
    a1 = gpio_data[1]
    a2 = gpio_data[2]
    a3 = gpio_data[3]
    a4 = gpio_data[4]
    a5 = gpio_data[5]
    a6 = gpio_data[6]
    a7 = gpio_data[7]
    a8 = gpio_data[8]
    a9 = gpio_data[9]
    a10 = gpio_data[10]
    a11 = gpio_data[11]
    a12 = gpio_data[12]
    a13 = gpio_data[13]
    a14 = gpio_data[14]
    a15 = gpio_data[15]
    a16 = gpio_data[16]
    a17 = gpio_data[17]
    a18 = gpio_data[18]
    a19 = gpio_data[19]
    a20 = gpio_data[20]
    a21 = gpio_data[21]
    a22 = gpio_data[22]
    a23 = gpio_data[23]
    a24 = gpio_data[24]
    a25 = gpio_data[25]
    a26 = gpio_data[26]
    a27 = gpio_data[27]
    a28 = gpio_data[28]
    a29 = gpio_data[29]
    a30 = gpio_data[30]
    a31 = gpio_data[31]

    ##formatter:off
    t = (a0 ^ (a16 >> 16)) & 0x0000FFFF; a0 ^= t; a16 ^= (t << 16)
    t = (a1 ^ (a17 >> 16)) & 0x0000FFFF; a1 ^= t; a17 ^= (t << 16)
    t = (a2 ^ (a18 >> 16)) & 0x0000FFFF; a2 ^= t; a18 ^= (t << 16)
    t = (a3 ^ (a19 >> 16)) & 0x0000FFFF; a3 ^= t; a19 ^= (t << 16)
    t = (a4 ^ (a20 >> 16)) & 0x0000FFFF; a4 ^= t; a20 ^= (t << 16)
    t = (a5 ^ (a21 >> 16)) & 0x0000FFFF; a5 ^= t; a21 ^= (t << 16)
    t = (a6 ^ (a22 >> 16)) & 0x0000FFFF; a6 ^= t; a22 ^= (t << 16)
    t = (a7 ^ (a23 >> 16)) & 0x0000FFFF; a7 ^= t; a23 ^= (t << 16)
    t = (a8 ^ (a24 >> 16)) & 0x0000FFFF; a8 ^= t; a24 ^= (t << 16)
    t = (a9 ^ (a25 >> 16)) & 0x0000FFFF; a9 ^= t; a25 ^= (t << 16)
    t = (a10 ^ (a26 >> 16)) & 0x0000FFFF; a10 ^= t; a26 ^= (t << 16)
    t = (a11 ^ (a27 >> 16)) & 0x0000FFFF; a11 ^= t; a27 ^= (t << 16)
    t = (a12 ^ (a28 >> 16)) & 0x0000FFFF; a12 ^= t; a28 ^= (t << 16)
    t = (a13 ^ (a29 >> 16)) & 0x0000FFFF; a13 ^= t; a29 ^= (t << 16)
    t = (a14 ^ (a30 >> 16)) & 0x0000FFFF; a14 ^= t; a30 ^= (t << 16)
    t = (a15 ^ (a31 >> 16)) & 0x0000FFFF; a15 ^= t; a31 ^= (t << 16)

    t = (a0 ^ (a8 >> 8)) & 0x00FF00FF; a0 ^= t; a8 ^= (t << 8)
    t = (a1 ^ (a9 >> 8)) & 0x00FF00FF; a1 ^= t; a9 ^= (t << 8)
    t = (a2 ^ (a10 >> 8)) & 0x00FF00FF; a2 ^= t; a10 ^= (t << 8)
    t = (a3 ^ (a11 >> 8)) & 0x00FF00FF; a3 ^= t; a11 ^= (t << 8)
    t = (a4 ^ (a12 >> 8)) & 0x00FF00FF; a4 ^= t; a12 ^= (t << 8)
    t = (a5 ^ (a13 >> 8)) & 0x00FF00FF; a5 ^= t; a13 ^= (t << 8)
    t = (a6 ^ (a14 >> 8)) & 0x00FF00FF; a6 ^= t; a14 ^= (t << 8)
    t = (a7 ^ (a15 >> 8)) & 0x00FF00FF; a7 ^= t; a15 ^= (t << 8)
    t = (a16 ^ (a24 >> 8)) & 0x00FF00FF; a16 ^= t; a24 ^= (t << 8)
    t = (a17 ^ (a25 >> 8)) & 0x00FF00FF; a17 ^= t; a25 ^= (t << 8)
    t = (a18 ^ (a26 >> 8)) & 0x00FF00FF; a18 ^= t; a26 ^= (t << 8)
    t = (a19 ^ (a27 >> 8)) & 0x00FF00FF; a19 ^= t; a27 ^= (t << 8)
    t = (a20 ^ (a28 >> 8)) & 0x00FF00FF; a20 ^= t; a28 ^= (t << 8)
    t = (a21 ^ (a29 >> 8)) & 0x00FF00FF; a21 ^= t; a29 ^= (t << 8)
    t = (a22 ^ (a30 >> 8)) & 0x00FF00FF; a22 ^= t; a30 ^= (t << 8)
    t = (a23 ^ (a31 >> 8)) & 0x00FF00FF; a23 ^= t; a31 ^= (t << 8)

    t = (a0 ^ (a4 >> 4)) & 0x0F0F0F0F; a0 ^= t; a4 ^= (t << 4)
    t = (a1 ^ (a5 >> 4)) & 0x0F0F0F0F; a1 ^= t; a5 ^= (t << 4)
    t = (a2 ^ (a6 >> 4)) & 0x0F0F0F0F; a2 ^= t; a6 ^= (t << 4)
    t = (a3 ^ (a7 >> 4)) & 0x0F0F0F0F; a3 ^= t; a7 ^= (t << 4)
    t = (a8 ^ (a12 >> 4)) & 0x0F0F0F0F; a8 ^= t; a12 ^= (t << 4)
    t = (a9 ^ (a13 >> 4)) & 0x0F0F0F0F; a9 ^= t; a13 ^= (t << 4)
    t = (a10 ^ (a14 >> 4)) & 0x0F0F0F0F; a10 ^= t; a14 ^= (t << 4)
    t = (a11 ^ (a15 >> 4)) & 0x0F0F0F0F; a11 ^= t; a15 ^= (t << 4)
    t = (a16 ^ (a20 >> 4)) & 0x0F0F0F0F; a16 ^= t; a20 ^= (t << 4)
    t = (a17 ^ (a21 >> 4)) & 0x0F0F0F0F; a17 ^= t; a21 ^= (t << 4)
    t = (a18 ^ (a22 >> 4)) & 0x0F0F0F0F; a18 ^= t; a22 ^= (t << 4)
    t = (a19 ^ (a23 >> 4)) & 0x0F0F0F0F; a19 ^= t; a23 ^= (t << 4)
    t = (a24 ^ (a28 >> 4)) & 0x0F0F0F0F; a24 ^= t; a28 ^= (t << 4)
    t = (a25 ^ (a29 >> 4)) & 0x0F0F0F0F; a25 ^= t; a29 ^= (t << 4)
    t = (a26 ^ (a30 >> 4)) & 0x0F0F0F0F; a26 ^= t; a30 ^= (t << 4)
    t = (a27 ^ (a31 >> 4)) & 0x0F0F0F0F; a27 ^= t; a31 ^= (t << 4)

    t = (a0 ^ (a2 >> 2)) & 0x33333333; a0 ^= t; a2 ^= (t << 2)
    t = (a1 ^ (a3 >> 2)) & 0x33333333; a1 ^= t; a3 ^= (t << 2)
    t = (a4 ^ (a6 >> 2)) & 0x33333333; a4 ^= t; a6 ^= (t << 2)
    t = (a5 ^ (a7 >> 2)) & 0x33333333; a5 ^= t; a7 ^= (t << 2)
    t = (a8 ^ (a10 >> 2)) & 0x33333333; a8 ^= t; a10 ^= (t << 2)
    t = (a9 ^ (a11 >> 2)) & 0x33333333; a9 ^= t; a11 ^= (t << 2)
    t = (a12 ^ (a14 >> 2)) & 0x33333333; a12 ^= t; a14 ^= (t << 2)
    t = (a13 ^ (a15 >> 2)) & 0x33333333; a13 ^= t; a15 ^= (t << 2)
    t = (a16 ^ (a18 >> 2)) & 0x33333333; a16 ^= t; a18 ^= (t << 2)
    t = (a17 ^ (a19 >> 2)) & 0x33333333; a17 ^= t; a19 ^= (t << 2)
    t = (a20 ^ (a22 >> 2)) & 0x33333333; a20 ^= t; a22 ^= (t << 2)
    t = (a21 ^ (a23 >> 2)) & 0x33333333; a21 ^= t; a23 ^= (t << 2)
    t = (a24 ^ (a26 >> 2)) & 0x33333333; a24 ^= t; a26 ^= (t << 2)
    t = (a25 ^ (a27 >> 2)) & 0x33333333; a25 ^= t; a27 ^= (t << 2)
    t = (a28 ^ (a30 >> 2)) & 0x33333333; a28 ^= t; a30 ^= (t << 2)
    t = (a29 ^ (a31 >> 2)) & 0x33333333; a29 ^= t; a31 ^= (t << 2)

    m = 0x55555555
    t = (a0 ^ (a1 >> 1)) & 0x55555555; a0 ^= t; a1 ^= (t << 1)
    t = (a2 ^ (a3 >> 1)) & 0x55555555; a2 ^= t; a3 ^= (t << 1)
    t = (a4 ^ (a5 >> 1)) & 0x55555555; a4 ^= t; a5 ^= (t << 1)
    t = (a6 ^ (a7 >> 1)) & 0x55555555; a6 ^= t; a7 ^= (t << 1)
    t = (a8 ^ (a9 >> 1)) & 0x55555555; a8 ^= t; a9 ^= (t << 1)
    t = (a10 ^ (a11 >> 1)) & 0x55555555; a10 ^= t; a11 ^= (t << 1)
    t = (a12 ^ (a13 >> 1)) & 0x55555555; a12 ^= t; a13 ^= (t << 1)
    t = (a14 ^ (a15 >> 1)) & 0x55555555; a14 ^= t; a15 ^= (t << 1)
    t = (a16 ^ (a17 >> 1)) & 0x55555555; a16 ^= t; a17 ^= (t << 1)
    t = (a18 ^ (a19 >> 1)) & 0x55555555; a18 ^= t; a19 ^= (t << 1)
    t = (a20 ^ (a21 >> 1)) & 0x55555555; a20 ^= t; a21 ^= (t << 1)
    t = (a22 ^ (a23 >> 1)) & 0x55555555; a22 ^= t; a23 ^= (t << 1)
    t = (a24 ^ (a25 >> 1)) & 0x55555555; a24 ^= t; a25 ^= (t << 1)
    t = (a26 ^ (a27 >> 1)) & 0x55555555; a26 ^= t; a27 ^= (t << 1)
    t = (a28 ^ (a29 >> 1)) & 0x55555555; a28 ^= t; a29 ^= (t << 1)
    t = (a30 ^ (a31 >> 1)) & 0x55555555; a30 ^= t; a31 ^= (t << 1)
    ##formatter:on

    gpio_data[0] = a0
    gpio_data[1] = a1
    gpio_data[2] = a2
    gpio_data[3] = a3
    gpio_data[4] = a4
    gpio_data[5] = a5
    gpio_data[6] = a6
    gpio_data[7] = a7
    gpio_data[8] = a8
    gpio_data[9] = a9
    gpio_data[10] = a10
    gpio_data[11] = a11
    gpio_data[12] = a12
    gpio_data[13] = a13
    gpio_data[14] = a14
    gpio_data[15] = a15
    gpio_data[16] = a16
    gpio_data[17] = a17
    gpio_data[18] = a18
    gpio_data[19] = a19
    gpio_data[20] = a20
    gpio_data[21] = a21
    gpio_data[22] = a22
    gpio_data[23] = a23
    gpio_data[24] = a24
    gpio_data[25] = a25
    gpio_data[26] = a26
    gpio_data[27] = a27
    gpio_data[28] = a28
    gpio_data[29] = a29
    gpio_data[30] = a30
    gpio_data[31] = a31


class TestMemoryUtils(unittest.TestCase):
    def test_transpose(self):
        gpio_data = [
            0b00100000000000000000000000000001,  # 0
            0b00100000000000000000000000000001,  # 1
            0b00100000000000000000000000000001,  # 2
            0b00100000000000000000000000000001,  # 3
            0b00100000000000000000000000000001,  # 4
            0b00100000000000000000000000000001,  # 5
            0b00100000000000000000000000000001,  # 6
            0b00100000000000000000000000000001,  # 7
            0b00100000000000000000000000000001,  # 8
            0b00100000000000000000000000000001,  # 9
            0b00100000000000000000000000000001,  # 10
            0b00100000000000000000000000000001,  # 11
            0b00100000000000000000000000000001,  # 12
            0b00100000000000000000000000000001,  # 13
            0b00100000000000000000000000000001,  # 14
            0b00100000000000000000000000000001,  # 15
            0b00100000000000000000000000000001,  # 16
            0b00100000000000000000000000000001,  # 17
            0b00100000000000000000000000000001,  # 18
            0b00100000000000000000000000000001,  # 19
            0b00100000000000000000000000000001,  # 20
            0b00100000000000000000000000000001,  # 21
            0b00100000000000000000000000000001,  # 22
            0b00100000000000000000000000000001,  # 23
            0b00100000000000000000000000000001,  # 24
            0b00100000000000000000000000000001,  # 25
            0b00100000000000000000000000000001,  # 26
            0b00100000000000000000000000000001,  # 27
            0b00100000000000000000000000000001,  # 28
            0b00100000000000000000000000000001,  # 29
            0b00100000000000000000000000000001,  # 30
            0b00100000000000000000000000000001  # 31
        ]
        t0 = int(time.time() * 1000)
        for i in range(165):
            transpose32(gpio_data)
        t1 = int(time.time() * 1000)
        print("transpose:" + str(t1 - t0))

    pass


if __name__ == '__main__':
    unittest.main()
